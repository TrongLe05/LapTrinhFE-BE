using TH17012026.Application.DTOs;
using TH17012026.Application.Interfaces;
using TH17012026.Domain.Entities;

namespace TH17012026.Application.Services
{
    public class StudentService : IStudentService
    {
        private readonly IStudentRepository _studentRepository;
        private readonly IClassRepository _classRepository;

        public StudentService(IStudentRepository studentRepository, IClassRepository classRepository)
        {
            _studentRepository = studentRepository;
            _classRepository = classRepository;
        }

        public List<StudentDto> GetAllStudents()
        {
            var students = _studentRepository.GetAll();
            return students.Select(s => new StudentDto
            {
                Id = s.Id,
                FullName = s.FullName,
                Email = s.Email,
                DateOfBirth = s.DateOfBirth,
                ClassId = s.ClassId,
                ClassName = s.Class?.Name
            }).ToList();
        }

        public StudentDto GetStudentById(int id)
        {
            var student = _studentRepository.GetById(id);
            if (student == null) return null;

            return new StudentDto
            {
                Id = student.Id,
                FullName = student.FullName,
                Email = student.Email,
                DateOfBirth = student.DateOfBirth,
                ClassId = student.ClassId,
                ClassName = student.Class?.Name
            };
        }

        public StudentDto CreateStudent(CreateStudentDto dto)
        {
            // Validate if class exists
            var classExists = _classRepository.GetById(dto.ClassId);
            if (classExists == null)
                throw new Exception($"Class with Id {dto.ClassId} not found");

            var student = new Student
            {
                FullName = dto.FullName,
                Email = dto.Email,
                DateOfBirth = dto.DateOfBirth,
                ClassId = dto.ClassId
            };

            _studentRepository.Add(student);

            return GetStudentById(student.Id);
        }

        public StudentDto UpdateStudent(int id, UpdateStudentDto dto)
        {
            var student = _studentRepository.GetById(id);
            if (student == null) return null;

            // Validate if class exists
            var classExists = _classRepository.GetById(dto.ClassId);
            if (classExists == null)
                throw new Exception($"Class with Id {dto.ClassId} not found");

            student.FullName = dto.FullName;
            student.Email = dto.Email;
            student.DateOfBirth = dto.DateOfBirth;
            student.ClassId = dto.ClassId;

            _studentRepository.Update(student);

            return GetStudentById(id);
        }

        public bool DeleteStudent(int id)
        {
            var student = _studentRepository.GetById(id);
            if (student == null) return false;

            _studentRepository.Delete(student);
            return true;
        }
    }
}
